# 通信指令  

==以下为blinker 2.x通信指令，请确保blinker app和blinker lib版本都是2.x.x==  
  
在你不了解这些指令的情况下，也可以使用blinker库进行设备开发。  
这个文档主要用于开发那些blinker还不支持的设备，你也可以通过本文档深入了解blinker。  

blinker提供了 **UI组件** 和 **内置组件** 两种类型的组件。  
app与设备间的通信指令都采用 **json格式** ，所有指令都以 **\\n** (换行符)结尾。

>1. [UI组件](#UI组件 "UI组件")
	1. [文字组件](#文字组件 "文字组件")
	1. [数据组件](#数据组件 "数据组件")
	1. [按键组件](#按键组件 "按键组件")
	1. [滑块组件](#滑块组件 "滑块组件")
	1. [颜色组件](#颜色组件 "颜色组件")
	1. [摇杆组件](#摇杆组件 "摇杆组件")
	1. [调试组件](#调试组件 "调试组件")
	1. [图表组件](#图表组件 "图表组件")
	1. [定时组件](#定时组件 "定时组件")
1. [内置功能](#内置功能 "内置功能")
	1. [手机震动](#手机震动 "手机震动")
	1. [手机姿态](#手机姿态 "手机姿态")
	1. [位置获取](#位置获取 "位置获取")
	1. [状态查询](#状态查询 "状态查询")
	1. [消息通知](#消息通知 "消息通知")


## UI组件
**UI组件** 即是APP上呈现给用户组件，用户可以通过这些组件和设备端交互。  
每一个组件都有一个key，key可以在app和设备端上设置。  
<br />
为缩短通信数据长度，所有key都有做精简，用到的key如下:   

| 数据 | 精简key | 说明 |
|---|---|---|
| 文本(text) | tex | 文本数据 |
| 数值(value) | val | 数值数据 |
| 单位(unit) | uni | 数据单位 |
| 图标(icon) | ico | 图标(可用图标见https://fontawesome.com/) |
| 颜色(color) | col | 16进制颜色，如:"FFFFFF" |
| 开关(switch) | swi | 开关状态,可用值"on"和"off" |

### 文字组件  
文字组件有两个作用：  
1.显示用户自定义文本  
做文本显示时，只需要app上设置即可  
2.显示设备发送到app的文字内容  
 当app接收上以上数据时，会将key为"tex-abc"的文字组件内容刷新。  
用于显示文字的模块  

#### 反馈指令示例：  
```json
{
    "tex-abc":
    {
        "tex":"文字1",
        "tex1":"文字2",
    }
} 
```
<br />

### 数据组件  
数字组件是用于呈现单一数字型数据的组件   

#### 反馈指令示例：  
```json
{
    "num-abc":{
        "val":30,
        "ico":"far icon",
        "col":"#FFFFFF",
        "tex":"CESHI",
        "uni":"%",
    }
}
```
<br />

### 按键组件  

#### 主动指令示例
**当按键为普通模式时：**
轻触按键：
```
{"btn-abc":"tap"}
```
说明key为"btn-abc"的按键被触发。  

按下未放开
```
{"btn-abc":"press"}
```
释放按键
```
{"btn-abc":"pressup"}
```
**当按键为开关模式：**
```
{"btn-abc":"on"}
```
或
```
{"btn-abc":"off"}
```

#### 反馈指令示例：
```json
{
    "btn-abc":
    {
        "swi":"on",
        "tex":"文字1",
        "ico":"fal fa-power-off",
        "col":"#FFFFFF"
    }
}
```
<br />  

### 滑块组件  

#### 主动指令示例
拖动滑动条，手机将向设备发送：  
```
{"ran-abc":101}
```
"ran-abc"为滑动条的key，用户可自定义，101为具体数值。  
设备可以向app发送同样的指令，改变app上滑动条的显示状态，如：  
```
{"ran-abc":255}
```
app会将key为"tog-abc"的滑动条组件的滑块调整到255位置。  
滑动条数值范围为0~255。 
#### 反馈指令示例：
```json
{
    "btn-abc":
    {
        "val":100,
        "col":"#FFFFFF",
        "tex":"文字1"
    }
}
```

<br />  

### 颜色组件  
拖动颜色选择滑动条，手机将向设备发送：  
```
{"col-abc":[255,0,0,255]}
```
其值为一个数据，数组中的数据分别是红绿蓝（RGB）三色的值  

#### 反馈指令示例：
```json
{
    "col-abc":[255,255,255,255]
}
```
<br />  


### 摇杆组件  
拖动摇杆，app将向设备发送： 
```
{"joy-abc":[208,255]}
```
摇杆拉到左下角发送的数据为：  
```
{"joy-abc":[0,0]}
```
摇杆拉到右上角发送的数据为：  
```
{"joy-abc":[255,255]}
```
释放摇杆，摇杆会归到中心位置，发送的数据为：  
```
{"joy-abc":[128,128]}
``` 

摇杆组件不支持反馈指令
<br />  

### 调试组件  
设备向app发送的数据将被显示到调试组件中。  

### 图表组件  
待整理

### 定时组件  
定时组件有三种定时方式：1.定时 2.倒计时 3.循环定时
定时数据结构如下：
```json
[
    {
      "task":0,
      "ena": 1,
      "tim": 1000,
      "act": [{"btn":"tap"}, {"btn":"ttt"}],
      "day": [1, 1, 1, 1, 1, 1, 1]
    }
]
```
倒计时数据结构如下：
```json
{
    "run": 1,
    "ttim": 1000,
    "rtim": 200,
    "act": [{"btn":"tap"}, {"btn":"ttt"}],
}
```
循环定时数据结构如下：
```json
{
    "tim": 99,
    "run": 1,
    "dur1": 1000,
    "act1": [{"btn":"tap"}, {"btn":"ttt"}],
    "dur2": 3333,
    "act2": [{"btn":"tap"}, {"btn":"ttt"}],
}
```
设置定时数据：
```json
{
    "set":{
        "timing":{
        "task":0,
        "ena": 1,
        "tim": 1000,
        "act": [{"btn":"tap"}, {"btn":"ttt"}],
        "day": [1, 1, 1, 1, 1, 1, 1]
        }
    }
}
```
删除定时数据：
```json
{
    "set": {
       "timing": [{ 
           "dlt": "0" 
        }]
    }
}
```

获取定时数据：
```json
{"get":"timing"}
```

---
## 内置功能

### 状态获取  
可以向设备端发送状态查询指令  
```json
{"get":"state"}
```
当设备为蓝牙或WiFi设备时  
已连接  
```json
{"state":"connected"}
```
未连接  
```json
{"state":"disconnected"}
```
当设备为MQTT设备时  
在线  
```json
{"state":"online"}
```
离线  
```json
{"state":"offline"}
```

### 手机震动  
设备向app发送：  

震动一秒  
```
{"vibrate":1000}
```
值为时间，单位毫秒  
<br />  

### 手机姿态  
设备向app发送：  

开启ahrs输出  
```
{"ahrs":"on"}
```
关闭ahrs输出  
```
{"ahrs":"off"}
```
app向设备发送：  
开启ahrs输出功能后，手机会输出ahrs数据  
```
{"ahrs":[332,16,-77]}
```
<br />  

### 位置获取  
设备向手机发送：  
```
{"get":"gps"}
```
手机将会返回当前手机所在位置的经纬度信息，格式如下：  
```
{"gps":[103.907156,30.573667]}
```
<br />  

### 状态查询（心跳查询）  
app在查询设备状态时会发送：  
```json
{"get":"state"}
```
默认状态下，设备会返回：  
```json
// WiFi设备
{"state":"online"}
// BLE设备
{"state":"connected"}
```
可通过设备端API，在返回信息中添加其他数据，用于和app进行数据同步。  

<br />  

### 消息通知  
设备向app发送：  
```
{"notice":"notice content"}
```
app将会推送一条内容为"notice content"的通知给用户  
如果通知内容第一个字符为'!',如：  
```
{"notice":"!notice content"}
```
app将会推送一条内容为"notice content"的**警告**给用户  
